---
title: "DeepGame: Efficient Video Encoding for Cloud Gaming"
subtitle: "云游戏 ROI 预测视频编码"
layout: post
author: "L Hondong"
header-img: "img/post-bg-6.jpg"
mathjax: true
tags:
  - 视频编码
  - 云游戏
---

# DeepGame: Efficient Video Encoding for Cloud Gaming

Simon Fraser University

## 摘要

offloading the game rendering and encoding to cloud datacenters，高带宽和低延迟需求。DeepGame，降低带宽要求，且不影响玩家体验质量。使用时空深度神经网络学习玩家在游戏中的上下文兴趣以及该兴趣的时间相关性，然后对视频帧中的各个区域进行编码，这些区域的质量级别不同，与其上下文重要性成比例。

DeepGame不更改视频编码或视频游戏的源代码，也不需要客户端的任何附加硬件或软件。在开源云游戏平台上实现了DeepGame，并使用多个流行游戏评估了其性能。还对真实玩家进行了主观研究，以证明DeepGame的实用性。

DeepGame可以减少多达36%的带宽需求，同时保证玩家的感知质量，保证实时运行。

## 一、简介

### 1.1 Motivation

服务器完成游戏逻辑，渲染场景，编码视频帧。客户端使用视频解码器解码，播放接收到的帧。大型云游戏平台（如Stadia）实时向数百万玩家提供游戏流。与普通视频不同，视频游戏包含大尺寸对象细节、各种视觉效果（如灯光和烟雾效果）以及复杂的动画。因此，与普通视频相比，视频游戏需要更高带宽来传送视频。Netflix需要5-6Mbps能观看高清视频，而Stadia至少需要28Mbps才能玩高清游戏。

另外，现在的高质量游戏更耗费带宽，一些游戏分辨率高达4K，帧率高达144fps，即使是每个游戏会话所需带宽的小幅降低也可以为云游戏提供商带来数百万美元的节省，并使更多的玩家能够参与云游戏。

视频编码器面临着视频流质量、所需比特率和响应延迟之间的trade-off。视频游戏需要高比特率，这会增加网络传输和处理延迟；需要考虑每个帧内和连续帧之间的空间和时间质量，因为玩家对视觉失真十分敏感，如果不能生成具有高度可变比特率的游戏流，可能会导致缓冲区溢出，玩家端不可预测的播放延迟。

DeepGame，无需编解码器或游戏修改即可提供高质量的游戏流。主要想法是玩家对帧内的不同区域兴趣并不相同。然而，识别不同区域的相对重要性是复杂的，远远超出了计算机视觉文中传统的目标检测算法。这是因为对象的重要性取决于游戏环境。例如，在射击游戏中，目标对象（如敌人角色）比背景对象（如建筑物和树木）更重要，即使目标很小且纹理不太复杂。

DeepGame采用基于学习的方法来理解玩家在游戏中的上下文兴趣，预测跨帧的兴趣区域（ROI），并根据其重要性将比特分配给不同的区域。

与之前的工作不同， DeepGame不需要玩家的额外反馈，也不修改现有的编码器。因此，DeepGame在实践中更易于部署。

### 1.2 Contributions

1. 为游戏服务器提出了一个新的视频编码pipeline，以降低云游戏的带宽要求，同时保持感知质量。
2. 了解玩家如何与游戏交互，并在服务器上以较低的处理开销实时准确预测ROI。
3. 收集一个新的数据集，研究玩家如何通过跟踪他们的眼睛注视来与多个流行的视频游戏交互，
4. 实施DeepGame并将其集成到云游戏平台中，以展示其实时性能。
5. 主观研究结果表明，参与者一致认为使用DeepGame编码的游戏会话的质量高于使用基础编码器编码的游戏会话的质量。
6. DeepGame在不造成明显质量下降的情况下，将带宽需求减少了36%。


## 二、相关工作

有经验的玩家会很快的熟悉游戏场景，对细节敏感，所以能很快地观察到伪影，不满意。视频编码器负责实时生成高质量的流，其性能对云游戏平台的成功至关重要。

### 2.1 Challenges of Video Encoding in CG

1. 响应延迟，从玩家采取相应的动作到解码帧播放出来。最大容忍时间：动作游戏100ms，慢节奏游戏150ms，不像点播视频最大容忍延迟500ms，还有几秒的缓冲时间。  
延迟主要来自于三个方面：客户端播放、网络延迟和服务器处理延迟。其中网络延迟自己就能占到80%，这样视频编码的时间就更短了。因此，视频编码器需要在产生高质量流和产生额外延迟之间取得平衡。

2. 感知质量，bit allocation根据不同帧、宏块渲染复杂度，但是问题在于不能知道未来游戏帧的复杂度，因为不能等之后的帧渲染完成再编码当前帧。  
同时也需要考虑时间和空间质量，像是块效应和伪影。

3. Player Heterogeneity。不同玩家根据他们的技能和经验玩不同的游戏，在第一人称射击游戏中，有经验的玩家可以在不看目标的情况下预先开火，同一玩家可以根据游戏状态与游戏中的同一对象进行不同的交互。例如，足球比赛中的球在球员进攻时可能很重要，而在球员射门时则变得不那么重要。  
因此，视频编码器需要考虑不同的游戏环境和玩家行为。

4. 模块化和部署成本。云游戏的常见做法是将未经修改的游戏部署到这些平台上，此外，云游戏通常使用在许多处理器架构中已经具有硬件支持的通用视频编解码器，改变视频编解码器的内部结构是不现实的，它可能会增加大量的部署成本。因此，不应修改现成的视频编码器，也不应期望在游戏过程中获得额外的输入或特定于游戏的API。

### 2.2 相关工作

最新的AV1编码器，编码效率和视频质量都相当好，但是高计算要求和支持的设备数量有限阻碍了它在云游戏中的应用。一些主要的云游戏提供商使用自己的专有编解码器，Google Stadia使用其专有的VP9编码器和H.264编码器来支持多种客户端设备。

与H.264相比，H.265的带宽效率提高了50%，但是licensing问题。

ROI可以显著地减少带宽需求，然而之前的方法需要手动指定ROI，这需要游戏开发人员的协作来提供此类信息。DeepGame不需要任何手动输入或游戏开发人员的协作。

后来提出客户端人眼跟踪设备的ROI识别编码方法。但是，使用眼睛跟踪设备会给系统带来额外的处理延迟，并且只能与兼容的客户端设备一起工作。

## 三、方法

1. Player Contextual Interest。并非所有的游戏帧和帧内的对象都同等重要，当玩家以各种方式与游戏交互时，需要根据帧内的上下文捕捉玩家对各种游戏对象的兴趣。传统的视觉显著性算法无法捕捉这种上下文，因为它们通常为帧中的相似对象指定相同的重要性值，在DeepGame中，基于上下文对玩家的兴趣和游戏对象之间的潜在关系进行建模。
2. Temporal Correlation of Interest。利用人类视觉系统（HVS）的一些特性以及玩家与视频游戏交互的本质，首先，人眼通常会盯着一个区域几十到几百毫秒，这被称为注视期，其次，当离开注视点时，关注度呈指数级下降。这被建模为具有eccentricity angle偏心角的指数函数。最后，玩家的兴趣和游戏对象之间的关系往往会持续几帧，因为对象不会在亚毫秒尺度上突然改变位置。因此构建一个模型来预测注视点，并重点研究玩家如何在连续的帧中与游戏交互。
3. Modern Encoders are Controllable。尽管现有的编解码器实现非常复杂，但它们提供了一组相对简单的API来控制编码参数和比特率，而无需修改底层视频编码算法。支持H.264和H.265等主要视频编解码器的libavcodec library允许缩放、转码和修改图片格式和编码比特率。控制帧中每个宏块的量化参数（QP），这很容易通过API实现，并且不需要更改视频编解码器的源代码。

<div align=center><img src="/assets/DeepGame-2022-01-12-11-10-05.png" alt="DeepGame-2022-01-12-11-10-05" style="zoom:50%;" /></div>

总的来说，DeepGame在game process 和视频编码process之间运行，输入是由游戏过程生成的原始游戏帧，输出是编码参数（QP），视频编码器使用这些参数生成要传输到客户端的编码帧。

DeepGame包括三个阶段：1. 场景分析，2. ROI预测，3. 编码参数计算。三个阶段并行运行，同时将输出从一个阶段转发到下一个阶段。

场景分析和ROI预测阶段构建时空模型，以识别ROI的位置以及它们如何随时间变化，最后一个阶段使用预测的感兴趣区域和人类视觉系统的特性来计算每帧中不同区域的权重。

### 3.1 Spatio-Temporal Prediction of ROIs

从场景分析阶段开始，在该阶段中识别各个游戏帧中的对象，然后，多个连续帧的对象被送入第二阶段，第二阶段对这些对象之间的上下文和关系进行建模，并使用该信息预测在接下来的短时间内玩家可能关注的帧中的区域。

<div align=center><img src="/assets/DeepGame-2022-01-12-11-10-29.png" alt="DeepGame-2022-01-12-11-10-29" style="zoom:50%;" /></div>

#### 场景分析

分析给定游戏帧中的视觉特征，大多数模型相当复杂，推理速度较慢，因此无法满足CG中的低延迟要求。提出了一种基于Yolo的轻量级目标检测模型，为CG实时运行提供了足够的精度。13个卷积层组成，具有maxpooling 和 skip connections，网络的主干是Darknet，使用COCO数据集对其进行训练，并对其进行微调以识别最重要的游戏对象，场景分析模型的输入是单个帧，输出帧中每个已识别的对象及其坐标、宽度和高度，以及该对象的类别/类型。

#### ROI预测

为了考虑游戏情境中的时间变化，使用LSTM在5-10帧上记录游戏上下文的动态，LSTM网络中的隐藏状态模拟了玩家的行为对连续帧中不同区域的相对重要性的影响。例如，将光标从一个位置移动到另一个位置可能意味着ROI已经移动。此外，输出会根据过去的记忆随时间演化，隐藏状态将根据玩家过去行为的短期记忆形成。

为了识别ROI，将每个帧划分为𝑁 × 𝑀块，其中每个块可进一步划分为视频编码器的最小编码单元，通常为8×8像素。视频游戏中的对象可以在连续帧中以不同的模式和速度沿水平和垂直方向移动。因此将LSTM网络分为两个分支；一个用于水平方向，另一个用于垂直方向。水平（垂直）分支考虑沿水平（垂直）方向以块形式存在的对象，并预测𝑁（𝑀）块内的ROI。然后组合两个方向上的预测结果，以产生𝑁×𝑀块阵列形式的最终输出。ROI块在连续的帧内是连续的和相邻的，因为用户的视觉注意力不能在短时间内在不相交的区域之间移动。

<div align=center><img src="/assets/DeepGame-2022-01-12-11-11-03.png" alt="DeepGame-2022-01-12-11-11-03" style="zoom:50%;" /></div>

LSTM 128个隐藏单元，其输入大小取决于𝑁 或𝑀 以及游戏中物体的数量，使用两个具有RELU激活函数的完全连接层，其大小分别为64和32，批归一化层和dropout。每个时间步的输出被用来预测每个块的重要性。输出层有𝑁或𝑀输出，每个块一个，使用Sigmoid函数来创建一个概率值，该值指示块是否是ROI值。

为了准确预测ROI块，网络在帧内容和由玩家注视确定的ROI之间建立对应关系。因此，需要定义一个合适的损失函数，该函数在网络覆盖正确的ROI块时奖励网络，并在网络不必要地包括额外块并增加预测区域时增加惩罚，使用二元交叉熵的一个变体作为网络的损失函数。

在云游戏中，尤其是对于熟练玩家，最好更加保守，覆盖玩家可能关注的所有位置，即使网络在ROI中包含一些额外的块。然而，将许多块指定为ROI将实质上影响编码性能。为了解决这个问题，损失函数使用了一个附加参数𝑃 减少误报，即避免遗漏任何ROI块。

#### 码率控制

权重计算模块将ROI预测作为输入，并计算图1所示的码率控制器使用的权重。码率控制器使用计算出的权重、带宽预算和使用的比特来计算每个块的QP。

DeepGame实现了大量带宽节约并提高了视觉质量。然而，DeepGame需要训练提出的深度学习模型，并在服务器上实时运行。深度学习模型的训练是离线进行的，并且每种游戏类型(不是单独的游戏会话)进行一次，每当存在可能包含不同图形、分辨率或视觉效果的该游戏的主要版本发布时，就训练一次。大型游戏通常每年发布一次，甚至时间更长。

虽然训练机器学习模型可能需要几个小时，但在这些模型上运行推理要快得多，而且应该在每个游戏会话中进行。DeepGame的推理模型可以在通用的低端GPU上实时运行。此外，使用ONNX运行时环境优化了DeepGame的推理模型，也可以在CPU上实时运行。

除了运行经过训练的机器学习模型的推理，DeepGame还需要计算帧中块的权重，并将其映射到QPs，以及运行编码器的速率控制器。然而，这些都是简单的操作，每个帧大约需要1毫秒。

尽管DeepGame可以灵活地支持各种游戏而无需修改，但在少数情况下可能会产生不准确的ROI预测。当游戏几乎没有可识别的对象时，DeepGame可能无法识别屏幕的哪个部分是确切的ROI。例如，像Minecraft这样具有像素化图形的游戏，很难在其框架内识别感兴趣的对象。

## 四、实验

## 五、总结

预测精度：

为了评估所提出的ROI预测模型的性能，提出了两个重要指标：预测精度和预测区域。预测精度定义为模型准确预测ROI块的帧百分比，确定能够覆盖ROI块的程度。预测区域是附加的预测块，预测区域越小，编码效率越高。然而，额外的预测块对于覆盖所有可能的注视区域是必要的。

