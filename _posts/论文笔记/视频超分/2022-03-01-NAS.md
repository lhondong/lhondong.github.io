---
title: "Neural Adaptive Content-aware Internet Video Delivery"
subtitle: "NAS"
layout: post
author: "L Hondong"
header-img: "img/post-bg-13.jpg"
mathjax: true
tags:
  - 视频超分
  - 视频传输
---

# Neural Adaptive Content-aware Internet Video Delivery

## 摘要

视频流量在过去几十年中增长迅速，但是视频传输质量受到网络带宽资源的极大限制。

本文提出了一个新的视频传输框架，利用客户端算力和深度神经网络来减少提供高质量视频的必要性，使用 DNN 不受限于可用带宽来增强视频质量。解决了以下几个问题，客户端异构性，与比特率自适应的交互，以及 DNN 的传输。

在相同的带宽预算时平均 QoE 提高 43.08％，或者在提供相同的用户体验的同时可以节省 17.13％的带宽。

NAS 用神经网络在客户端增强在线视频清晰度，是一种运行在 HTTP（DASH）框架上的动态自适应流传输之上的系统设计。

给视频训练一个将低清晰度视频转成高清晰度视频的神经网络，在看在线视频的时候先下载神经网络，之后就可以只传低清视频，节约带宽。

现有的带宽自适应视频流技术没有在客户端的视频增强方案，基于神经网络的视频压缩技术刚刚起步，效果不佳。需要解决的问题：

- 神经网络太大怎么边下载边运行？
- 怎么规划神经网络的下载，以减少对视频下载的影响？

## 一、简介

目前的视频传输基础设施已经成功地通过两种关键技术来解决可扩展性挑战。

- 首先，在服务器端，分布式计算技术提供互联网内容交付。
- 其次，在客户端，自适应码率（ABR）解决了带宽不均匀的问题以及跨时间和空间的变化。

随着时间的推移，两种技术不断发展，以优化用户体验质量（QoE）。但是，现有内容分发网络（CDN）的局限性在于其质量很大程度上取决于服务器和客户端之间的带宽。当带宽资源受限时，用户 QoE 直接受到其影响 [43,47]。码率自适应是解决该问题的主要工具 [52]，然而，它对网络资源的依赖从根本上限制了用户体验的进一步提升。

受到不断增长的客户计算能力和深度学习的最新进展的启发，本文提出了一种提高视频质量的替代或补充方法，利用客户端计算应用深度神经网络（DNN）的视频内容质量增强方法来最大化用户 QoE。深度学习模型学习从低质量视频到高质量版本（如超分辨率）的映射，使得用户能够从较低质量的传输码流获得高分辨率（如 1080p）视频，从而在码率自适应的基础上最大化 QoE。

然而，通过 DNN 利用客户端计算资源会影响服务器/客户端系统并带来一些问题： 

1. 首先，CDN 服务器必须为它们提供的内容提供 DNN 模型，但是很难保证 DNN 的测试性能。对于看不见的/新的内容来说尤其不可靠，这对部署来说是一个很大的挑战。
2. 其次，客户端设备是完全不同的，它们的算力差异很大，甚至可能由于多路复用使得算力随时间变化。然而，基于 DNN 的质量增强必须实时以满足在线视频流。
3. 最后，基于 DNN 的质量增强具有基于 ABR 的 QoE 优化的级联效应。除了可用带宽之外，质量现在还取决于客户端 DNN 的可用性。因此，现有的 ABR 算法必须反映这些变化。

解决方案：

1. 为了保证 DNN 能够提供可靠的质量增强，需要内容感知方法，即 DNN 分别针对每个视频集进行训练。其想法是利用 DNN 的过拟合特性，并利用训练精度来提供可预测的高性能，而不是依赖不可预测的测试精度。
2. 实现可选、可扩展 DNN 模型：提供多个 DNN 模型供用户自行选择，这些 DNN 模型的计算时间不一样。客户端不需要下载所有的 DNN 就能自行选择最适合自己的 DNN。而且因为有些 DNN 模型很大，需要花费较长的时间进行传输，因此，NAS 设计了一个增量式的 DNN 传输，先传输一部分的 DNN 模型，且这种部分模型是可以直接使用的。
3. 最后，为了协调基于 ABR 的 QoE 优化和基于 DNN 的质量增强（DNN 模型的传输会与视频资源的传输进行带宽资源的竞争），设计了一种支持内容增强的 ABR 算法来优化 QoE，使用强化学习 [68] 决定何时下载 DNN 模型、何时下载视频块以及每个视频块使用的视频比特率。

### Contributions

1. 端到端视频流系统：NAS 是一种端到端视频流系统，集成了内容感知方法，DNN 用于超分辨率，可扩展并随时预测，具有在现有自适应流框架上处理设备异构性的机制。
2. 在自适应流传输中使用 DNN：NAS 是第一个在自适应流传输环境中应用超分辨率 DNN 的系统。从机器学习（ML）方面来看，是第一个将 DNN 流，超分辨率和随时预测应用于自适应流媒体的方法。
3. 内容感知 DNN：NAS 将视频与相应的内容感知 DNN 一起流式传输到其客户端。这是 NAS 的关键新组件，也可视为视频编码的新方法。

## 二、Motivation

改善视频流质量的传统方法包括：

- 使用更好的编解码器 [11,12]；
- 优化自适应比特率算法 [20,39,42]；
- 选择更好的服务器和 CDN [17,50,74]；
- 通过集中控制 plane 在客户端和服务器之间进行协调 [51,54]。

这些方法侧重于如何最好地利用网络资源，但存在两个共同的局限性。

#### 客户端算力没有得到充分利用

大多数用户主要在 PC 上观看视频，这些 PC 具有显著的计算能力。移动设备是下一代视频平台，同样也配备了功耗高效的 GPU[29]。图 1 显示了 GPU 在移动设备和台式机上的计算能力呈指数增长。最新的移动设备甚至还有用于神经处理的专用硬件 [7]。但是，当前的视频传输基础设施未充分利用客户端的算力。随着客户端不断增长的算力和不断增长的带宽需求，我们设想了一个视频传输系统，客户端可以在其中发挥积极作用，用来提高视频质量。

<div align=center><img src="/images/NAS-2022-01-12-13-08-48.png" alt="NAS-2022-01-12-13-08-48" style="zoom:50%;" /></div>

#### 当前视频编码的限制

现有的视频编码只能利用帧间或 GOP 内的信息冗余，没有充分利用大时间尺度下的冗余。

视频集通常包含大时间尺度的冗余。例如，对于数百万人观看的流行体育游戏，相同的物体（例如球和球员）和场景（例如篮球场）反复出现。同样，在电视剧，体育联赛中的比赛以及来自相同流媒体的视频中也存在很多冗余。这种频繁重复出现的高级特征包含可用于视频编码的有价值信息。

然而，标准视频编码（例如 MPEG 和 H.26x）仅捕获空间和短期冗余，缺乏利用运动图像的高级特征的能力。在一组图片（GOP）中，帧间编码对相邻帧之间的差值编码，来压缩运动图像 [30]。但是对于在线视频来说，GOP 通常只有几秒钟的时间 [13]，因此无法捕获在大时间尺度下的冗余。只要编解码器仅在 GOP 内压缩视频（可以说是流媒体的天生限制），使用复杂的编解码器也无法完全消除这种差距。

受此启发，我们设想了一种视频传输系统，通过捕获高级特征来利用这种冗余，并应用额外的客户端算力来打破传统视频编码的限制。为此，我们利用 DNN 从数据的低级表示中提取有意义特征 [23]。

### Goal

目标是实现一个将低分辨率作为输入，在客户端上通过 DNN 模型得到高分辨率视频的系统 NAS，使得在低质量的传输下，能获得高质量的视频和用户体验。第一步先考虑为点播视频提供服务，而不是实时视频流，并使用配备台式机 GPU 的个人计算机。

本文介绍了 NAS，第一个使用客户端计算能力将 DNN 应用于视频内容以最大化用户 QoE 的视频传输框架。

## 三、背景和相关工作

### 3.1 Adaptive streaming

Apples HLS [1]，DASH [2] 用来处理现实世界中不可预测的带宽变化。视频被编码成各种比特率（或分辨率）并被分成固定长度，通常为 2-10 秒。自适应分辨率算法（ABR）决定每个视频块的比特率。

传统的 ABR 算法使用的启发式的方法选择比特率。

MPC[77] 和 Pensieve[52] 证明直接优化所需的 QoE 目标比基于启发式的方法效果更好。Pensieve 使用深度强化学习，并通过“观察”学习过去决策和当前状态如何影响视频质量。Oboe [21] 参考离线预计算结果，根据网络条件动态调整 ABR 参数。虽然这些算法能够成功应对带宽变化，但它们既不考虑客户端质量增强的影响，也不考虑同时传输 DNN 和视频块的动态效果。

### 3.2 Super-resolution

MDSR[49] 集成了残差神经网络架构 [34] 并支持多尺度输入。在 NAS 中，我们在自适应流媒体上应用超分辨率，通过在客户端增强低质量视频来改善用户 QoE。

### 3.3 Scalable DNN

可扩展 DNN 是一种新兴的 DNN，旨在动态适应计算资源约束，实现随时预测 [36]。浅层和深层网络分别用于资源受限和资源充足的环境 [24,36]。 ISResNeXt[48] 选择性的使用适合 DNN 宽度（或通道）的细网络和宽网络。可扩展的 DNN 主要应用于图像分类/检测任务。NAS 将随时预测应用于超分辨率，并使用它在流媒体环境中提供增量质量增强。

### 3.4 DNN-based media compression

最近的基于 DNN 的图像压缩方法已经超过了传统的图像编码方法，如 JPEG2000 和 WebP。

DNN 压缩方法的优势主要来自两个方面：1）直接优化目标质量度量；2）根据图像调整编解码器配置，而不是使用固定配置 [61]。然而，将其应用于视频存在显著的挑战，包括减少 DNN 编码图像之间帧间冗余的问题。最近的一项工作 [72] 使用 DNN 进行 I 帧压缩和帧插值。然而，基于 DNN 的视频压缩仅能达到“与 MPEG-2 相当的性能”并且在提供实时解码方面不尽如人意 [72]。NAS 旨在使用 DNN 增强现有视频传输，通过在传统视频编解码器上应用超分辨率 DNN 实现逐帧质量增强。

### 3.5 Video processing systems

由于视频编码所需的规模，后端视频处理系统变得越来越重要。

快速交互共享的延迟、编码的系统效率、可扩展性和容错性是主要问题 [31,37,70]。

SVE [37] 介绍了 Facebook 中使用的后处理系统。ExCamera[31] 使用大规模并行来实现交互式和协作式编辑。他们专注于在不改变客户端的情况下解决数据中心内的分布式系统问题，而我们则专注于服务器和客户端之间的工作分工。

### 3.6 Studies on video control plane

视频控制平面的研究 [32,41,44,51] 确定了 CDN 在性能上的空间和时间多样性，并倡导建立一个互联网规模的控制平面，协调客户端行为，共同优化用户 QoE。虽然它们控制客户端行为，但它们不利用客户端计算来直接提高视频质量。

## 四、关键设计

### 4.1 内容感知 DNN

> Note, a fundamental trade-off exists between generalization and specialization for any machine learning approach.

任何机器学习方法的泛化和专业化之间存在基本的权衡（当模型容量变大，其性能下降），这被称为“无免费午餐”定理。

更糟糕的是，考虑到任何现有的 DNN 模型 [38,58]，用户可以生成任意低质量的“对抗性”新视频，这使得该服务容易受到质量攻击的降低。

内容感知方法可以被视为一种视频压缩，如图 3 所示。内容感知 DNN 捕获在大时间尺度（例如多个 GOP）发生的冗余，并在整个视频中运行。相比之下，传统的编解码器只能处理帧内或 GOP 内的帧之间的冗余。

<div align=center><img src="/images/NAS-2022-02-28-22-25-51.png" alt="NAS-2022-02-28-22-25-51" style="zoom:50%;" /></div>

在 NAS 中，我们使用使用 per-video 超分辨率 DNN 来演示新的编码方案。但是我们相信内容感知方法可以应用于一系列视频（内容相似），并扩展到与不同类型的 DNN 一起工作，例如帧内插 [56]。

### 4.2 可扩展 DNN

由于客户端设备的异构性、工作负载的变化和多路复用，可用的计算能力随时间和空间而变化。

在线视频流需要实时推断——DNN 推断必须至少与播放速度一样快。现有的超分辨率 DNN[28,45,49] 需要大量的计算能力，并且没有能力适应时变。因此，使用单个 DNN 既不能充分利用客户端的 GPU，也不能满足实时要求。

NAS 提供了多个 DNN，允许客户端动态地选择使用一个适合其算力的 DNN。类似于自适应流提供的多个比特率，NAS 提供了一系列 DNN 选项，这些 DNN 的推理时间（或计算要求）不同。

NAS 服务器提供多个 DNN 规格作为视频清单文件的一部分，提供了一种轻量级的机制，不要求客户端下载完整的 DNN，以便从可用选项中选择正确的 DNN。

然而，使用多个 DNN 也带来了新的困难，因为 DNN 的大小与其计算需求成比例，所以为高端 GPU 设备设计的 DNN 可能非常大（几 MB）。DNN 下载和使用需要很长时间。为了解决这个问题，我们设计了一个可扩展的 DNN，使客户端能够以增量的方式利用部分下载的模型。

可扩展 DNN 包含多个 bypass-able 可绕过的中间层，没有中间层的部分 DNN 也能够生成输出，如图 4 所示。此外，这种设计很自然地适应了由于多路复用而导致的计算能力的随时间变化。当计算资源充足时，客户端能使用所有的中间层，而计算资源不足时会自动绕过一定数量的中间层，从而能够进行任何时间的预测 [24，36，48]。

<div align=center><img src="/images/NAS-2022-01-12-13-10-36.png" alt="NAS-2022-01-12-13-10-36" style="zoom:50%;" /></div>

最后，使用多个可扩展 DNN 允许每个设备受益于部分下载的 DNN 中，且无论设备的计算能力如何，都提供相同级别的时间自适应。

### 4.3 集成 ABR

由于 NAS 使用 per-video DNN，客户端必须从服务器下载 DNN，然后进行质量增强。然而，DNN 下载也与视频流本身竞争带宽。因此，优先下载 DNN 模型可能会降低用户 QoE。同时，客户端可能会从早期 DNN 下载中获益，因为它可以在早期获得质量增强。由于 DNN 的存在造成了冲突，因此何时下载以及如何下载 DNN 至关重要。

NAS 的比特率自适应将下载 DNN 的决策与比特率选择结合起来，以实现 QoE 最大化。它考虑了影响用户 QoE 的另外三个因素：

1. 为了从质量增强中获益，必须先下载客户端 DNN；
2. 部分下载 DNN 与下载量成比例地提高质量；
3. DNN 块下载与视频块下载竞争带宽。

利用强化学习 [52] 并生成 ABR 算法，该算法集成了下载 DNN 模型的决策。将 DNN 模型划分为固定尺寸的块，并训练强化学习网络，该强化学习网络使用当前状态（例如，吞吐量测量、播放缓冲区占用、剩余视频块的数量）及历史状态作为输入输出决策（即下载视频还是 DNN 块）。使用由真实网络数据组成的大型训练集来训练强化学习网络 [9,60]。

使用强化学习做决定有许多好处：

1. 通过 NAS 直接优化目标 QoE 度量，实现基于 DNN 的质量改进；
2. RL 以优化 QoE 的方式平衡多个相互作用的因素，例如带宽变化、视频和 DNN 块之间的带宽共享以及部分 DNN 的质量增强；
3. 通过在 RL 网络中对 DNN 类型进行编码，自然地适应了多个 DNN 的使用。

第 5.3 章介绍了集成 ABR 的细节。

## 五、系统设计

NAS 是在 DASH[2] 中标准化的当前 HTTP 自适应流基础上实现的。首先解释系统运行的关键差异。

#### 新的视频输入（服务器端处理）

与 DASH 中一样，当视频片段被上传时，它被编码为多个比特率并分成块。此外，服务器还训练用于视频的内容感知 DNN，用于客户端质量增强 (§5.1)。然后，将它们的 URL 与 DNN 规格（§5.2）一起放入清单。

#### 客户端操作

客户端的视频播放器首先下载一个清单文件，其中包含视频可用 DNN 的列表。然后客户端根据自己的算力选择其中一个。客户端的 DNN 处理器使用轻量级机制来选择（§5.2）可用的最佳 DNN。然后，播放器根据集成自适应比特率 (ABR) 算法 (§5.3) 的决定，下载选择的 DNN 或视频块。

当下载 DNN 块时，播放器将其传递给 DNN 处理器，在客户端的计算设备（如 GPU）上加载（部分）DNN。当下载视频块时，播放器将其保存在播放缓冲区中，为立即播放做好准备。然后，播放器将播放缓冲区中的视频块与它们相关联的播放时间一起选择性地传递给 DNN 处理器以提高质量，这是神经网络处理的最后期限。当 DNN 处理器处理完一个块时，替换掉播放缓冲区中的原始块，播放质量增强的视频块。

#### 客户端神经处理

当 DNN 块到达时，DNN 处理器初始化 DNN，然后使用 DNN 对每帧进行质量增强以实现超分辨率。因此，DNN 处理器首先将视频块解码成帧，然后应用超分辨率 DNN。然后将得到的帧重新编码为视频块，视频块替换播放缓冲区中的原始块。解码、超分辨率和编码阶段流水线化和并行化以最小化延迟（详细信息参见§7.5）。

### 5.1 Content-aware DNN for DASH

#### 要求

- 满足多种分辨率作为输入；
- 视频质量提升满足实时播放的要求；
- 为了满足实时，要牺牲一些计算时间，平衡视频质量提升与时间开销。

传统的 MDSR 能实现多种分辨率作为输入，并且通过共享中间层来减少空间。

由于高分辨率的计算开销大，低分辨率的计算开销小，为了满足某些实时的要求，可能需要减少高分辨率的计算，如果减少中间层，由于共享层设计，会均匀地降低所有分辨率的质量，使较低分辨率遭受显著的质量降低。因此针对不同分辨率，设置独立的 DNN：

<div align=center><img src="/images/NAS-2022-01-12-13-10-36.png" alt="NAS-2022-01-12-13-10-36" style="zoom:50%;" /></div>

#### 训练

先使用一个流行的标准基准来训练一个通用的 DNN 模型 [19]。然后在每个视频片段上训练内容感知 DNN 模型，其权重初始化为来自通用模型的权重。这样可以将训练中的计算成本降低 5-6 倍，同时与随机初始化相比实现了类似的质量提升 [33]。

### 5.2 Adaptation to Computational Power

两种机制：multiple DNNs 和 anytime prediction。

#### 服务端：Providing multiple DNNs

提供四种不同质量的 DNN：Low，Medium，High，Ultra-high

<div align=center><img src="/images/NAS-2022-01-12-13-11-22.png" alt="NAS-2022-01-12-13-11-22" style="zoom:50%;" /></div>

服务器在清单文件中记录可用的 DNN 配置，包括 DNN 名称和级别、输入分辨率、层数和通道数。

#### 客户端：Choosing a DNN from multiple options

1. 下载 manifest list，获取四种 DNN 模型的信息（layars , channels）
2. 根据四种模型的信息，随机初始化权值来构建四种 DNN（不需要进行计算，所以随机初始化权值，只需要测试时间，客户端测试运行需要 1.64-3.40 秒）
3. 找到能满足实时要求且质量最高的 DNN 模型。

#### 服务端：Scalable DNN and anytime prediction

DNN 的中间层由多个残差块组成 [49]，每个残差块由两个卷积层组成。允许在推理过程中绕过连续的中间块，为了实现旁路，添加从中间块到最终层的直接连接，如图 4 所示，创建多条推理路径。

在每次训练迭代中，随机跳过中间层来计算网络输出和目标图像之间的误差。然后使用反向传播更新参数。特别地，以 1/2 的概率通过所有层（用于训练原始路径），然后均匀随机地通过路径来选择剩余路径中的一个。产生的 DNN 可以只使用 DNN 的一部分来生成输出图像，并且随着使用更多的层，可以提供递增的质量改进。最后，DNN 被分为块，服务器将块的 URL 放在视频清单中。第一个 DNN 块由所有输入分辨率的基本层组成，后续的块包含其余的 DNN。

- 高需求的 DNN 较大，不可能全部下载下载后再去使用，可让客户端边下边播，已下载的 DNN 部分也可用于视频的质量提升，随着 DNN 的下载越来越完全，视频的质量提升的也越来越高。
- DNN 的中间层是许多残差块，一个残差块包含两个卷积层，DNN 运算可以绕过连续的残差块进行计算。
- 训练的时候，50% 的概率运算完整的 DNN，50% 的概率随机绕过残差块，然后反向传播更新参数。
- 将 DNN 分成一个个块，第一块是基本块，接受多种分辨率作为输入。

#### 客户端：Using the scalable DNN

最小 DNN 的大小仅为完整 DNN（33 KB 到 768 KB）的 35.11%–36.14%，允许客户端从基于 DNN 的质量提升中尽早受益。

在每个时间间隔，客户端的 DNN 处理器首先计算其正在处理的块的播放时间之前剩余的时间量，以此计算在最后期限内能够使用的最大层数。客户端记录每个层的最新推断时间，并在推断时间发生变化时更新该表。根据经验将时间间隔设置为四秒钟，是一个视频块的长度，这样允许 NAS 客户端动态地适应可用计算能力的变化。

- 下载第一个 DNN 块，构造 DNN。
- 能从部分下载的 DNN 块中得到质量提升，DNN 下载越完全，得到的质量提升越大。
- 固定时间间隔计算 DNN 的计算时间，得到满足实时要求的 DNN 最大层数。

### 5.3 Integrated Bitrate Adaptation

#### 训练

为每个视频集训练单独的 DNN 时间开销和计算开销都很大，可以首先使用流行的标准基准来训练通用 DNN 模型，然后针对每个视频集单独训练，这减少了 5-6 倍的训练计算成本，同时实现了与随机初始化类似的质量增强。

#### 决策

先取 DNN 还是先取视频？

- 先下 DNN，这会带来未来的质量提升，同时牺牲当前视频的流媒体质量。
- 如果先取视频，比特率大小选择？优化当前视频的比特率，并延迟 DNN 的下载。

这个问题的解空间非常大，考虑到比特率的数量、视频和 DNN 块的下载顺序以及可用带宽的动态范围。因此使用强化学习（RL）框架通过全面的“经验”来直接优化目标（without using explicit decision labels）。

采用 A3C 的演员评论框架，从观察中学习策略（或 policy），并从原始观察中（例如下载的 DNN 模型、由 DNN 引起的质量改进、网络吞吐量样本以及播放缓冲）映射到上述决策。

#### RL 设计

对于每个迭代 $t$，agent 在观察到状态 $s_t$ 后做出反应 $a_t$，然后得到的奖励 $r_t$，同时更新到状态 $s_{t+1}$。

将策略定义为在给定状态 $s_{t}$ 时做出的动作 $a_{t}$ 的概率 $π(s_{t}, a_{t}) :\rightarrow[0, 1]$，目标是通过学习策略使得总回报 $\sum\limits_{t=0}^{\infty}\gamma^tr_t$ 最大。

其中 $a_{t}$ 是指下载 DNN 块还是下载特定比特率的视频块，$s_{t}$ 有如下几种情况：

<div align=center><img src="/images/NAS-2022-01-12-13-13-55.png" alt="NAS-2022-01-12-13-13-55" style="zoom:50%;" /></div>

$\gamma\in (0,1]$ 是回报率，$r_t$ 是用来衡量用户体验质量 QoE 的（是比特率效用、rebuffering 时间和所选比特率的平滑度的函数），定义如下：

$$
\frac{\sum_{n=1}^{N} q(R_{n})-\mu \sum_{n=1}^{N} T_{n}-\sum_{n=1}^{N-1}\vert q(R_{n+1})-q(R_{n})\vert }{N}
$$

其中 $N$ 是视频块的数量，$R_{n}$ 和 $T_{n}$ 是第 $n$ 块视频块的比特率和由其下载导致的回退时间，$\mu$ 表示回退惩罚， $q(R_{n})$ 是接受的比特率  $R_{n}$ 的质量。

为了显示 NAS 的基于 DNN 的质量提升，使用有效比特率 $R_{effective}$ 代替比特率 $R_{n}$，对于每一个视频块 $C_{n}$ 有：

$$
R_{effective}(C_n) = SSIM^{−1}(SSIM(DNN_m(C_n)))
$$

其中，$DNN_{m}(C_{n})$ 是视频块 $C_{n}$ 在下载 $DNN_{m}$ 之后提升的质量， $SSIM$ 用于检测视频质量的平均结构相似度，$SSIM^{-1}$ 将 $SSIM$ 值映射到视频比特率。为了创建映射，我们在每个比特率下测原始视频的 $SSIM$ 值，然后使用分段线性插值。

#### RL 训练

强化学习框架使用两个神经近似器，一个是 actor 表示策略，一个是 critic 用于评估策略，并使用策略梯度方法。（policy gradient method）

agent 首先按照当前的策略 $\pi_\theta(s_t,a_t)$ 生成轨迹，其中 $\theta$ 表示 actor 神经网络的参数（或权重）。critic 网络观察这些轨迹，并学习估计动作值函数 $Q^{\pi_\theta}(s_t,a_t)$，是从状态 $s_t$ 开始遵循策略 $\pi_\theta$ 采取行动时的总期望奖励。在每次迭代中， actor 网络使用该估计来更新模型：

$$\theta \leftarrow \theta + \alpha \sum\limits_t \nabla_\theta log \pi_\theta (s_t , a_t )(Q^{\pi_\theta} (s_t , a_t ) − V^{\pi_\theta} (s_t ))$$

其中，$V^{\pi_\theta}(s_t)$ 是表示从状态 $s_t$ 开始的 $\pi_\theta$ 的总期望奖励的值函数，$\alpha$ 是学习率。在 RL 框架中，因为奖励会影响内容感知 DNN 提供的平均 QoE 提升，所以 critic 网络学习估计更新后的总奖励。这使 actor 网络能够学习一种平衡视频和 DNN 下载的策略，以最大限度地提高 QoE。

使用一个使用类似于 Pensieve 的块级模拟器来加速 ABR 的训练，它跟踪网络吞吐量，模拟 NAS 的视频流动态。此外，对每个 DNN 的所有视频质量进行平均，从而预先计算基于 DNN 的质量增强。然后使用这些值来生成一个通用的 ABR 模型。

当下载 DNN 时，模拟器更新下载的 DNN 块数量。当下载视频块时，它将块添加到播放缓冲区。然后，它使用每个块的（有效）比特率效用和回退时间，计算反映基于 DNN 的质量增强的 QoE。注意，模拟器既不执行实际的视频下载，也不进行任何推断。因此，与实时仿真相比，可以减少 97.12%的训练时间。

## 六、实现

通过扩展一个 DASH 视频播放器来实现 NAS 客户端。服务器端（训练）和客户端（推理）DNN 处理都使用 Pytorch 实现。

表 4 是每个组件的 lines of code (LoC)。

#### NAS 客户端（DASH 视频播放器）

为了实现 NAS 客户端，对 dash.js [4] 进行了修改，是用 JavaScript 编写的 MPEG DASH 客户端的参考实现。

将集成的 ABR 和内容感知的 DNN 作为单独的进程运行。dash.js 用于通过进程间通信获取 ABR 决策和质量增强块。在图 5 中添加 DNN 元数据，如图 2 中所示。质量属性表示 DNN 质量等级。SegmentTemplate 的 DNN 属性用于创建块 URL，startNumber 和 endNumber 指示块索引范围。此外，清单文件还包括每个 DNN 的层数和通道数。

<div align=center><img src="/images/NAS-2022-03-01-22-20-42.png" alt="NAS-2022-03-01-22-20-42" style="zoom:50%;" /></div>

#### 训练内容感知 DNN

使用 Pytorch 实现了可扩展的超分辨率 DNN。通过随机裁剪低分辨率图像（例如，240p、360p、480p、720p）来输入 41×41 像素的图像补丁，并使用 ADAM 算法 [46] 来优化 DNN 参数。将小批量、权重衰减参数和学习速率分别设置为 $64$、$10^{-3}$ 和 $10^{-4}$。

使用通用模型的参数（4.1）初始化 DNN 模型。然后每分钟对视频进行 100 mini-batch 更新，以生成内容感知的 DNN。最后，将其参数从单精度（32 位）四舍五入到半精度（16 位），这将使 DNN 大小减半，同时保证性能下降最少（SSIM 几乎没有差异）。

#### 训练集成 ABR

通过扩展 Pensieve 的实现，实现了集成 ABR[8]。演员/评论网络的初始学习率分别设置为 $10^{-4}$ 和 $10^{-3}$。熵权值被初始化为 2。

迭代超过 60000 个周期的训练，其中在每个周期内将熵权重从指数 2 衰减到 0.055。最后选择为我们的训练提供最高 QoE 的 ABR 网络。

## 七、实验

通过回答以下问题来评估 NAS：

- NAS 与 baseline 竞争对手相比表现如何，训练成本是多少？
- NAS 的每个设计组件如何对整体性能做出贡献？
- NAS 是否有效地适应异构设备和客户端计算能力的时间变化？
- NAS 的端到端处理延迟和资源利用率是多少？

### 7.1 Methodology

#### Videos

Youtube 上三个热门流行频道，从每个支持 1080p 质量、长度大于 5 分钟的频道中挑选最受欢迎的视频，27 个视频片段的视频数量在 7M 到 737M 之间。

使用 H.264 编解码器 [11] 对每个 1080p 视频进行重新编码，其中 GOP（或块大小）、帧速率和比特率分别为 4 秒、24fps 和{400、800、1200、2400、4800}Kbps({240、360、480、720、1080}p 分辨率视频。

除非另有说明，我们使用整个视频进行训练，并播放前 5 分钟。在整个视频中进行训练可确保 NAS 在整个视频中提供一致的质量增强。

#### 网络跟踪

使用一个真实的带宽数据集，由来自挪威 3G 网络（2010-2011）[60] 的 508 条吞吐量 trace 和来自美国宽带（2016）[9] 的 421 条 trace 组成。过滤掉在较长时间内 (>100s) 持续体验低带宽 (<400Kbps) 的 trace，平均下来吞吐量范围为 0.38Mbps 到 4.69Mbps，平均吞吐量和中位吞吐量分别为 1.31Mbps 和 1.09Mbps。每个 trace 持续 320 秒，循环跟踪直到视频完全下载，随机选择 80% 的跟踪用于训练，其余 20% 用于测试。

#### Baseline

- Pensieve [52] uses deep reinforcement learning to maximize QoE.
- RobustMPC [77] uses playback buffer occupancy and throughput predictions over next five chunks to select the bitrate that maximizes QoE. We use the version reproduced by the authors of Pensieve [8].
- BOLA [66] uses Lyapunov optimization based on playback buffer occupancy. We use the BOLA ver- sion implemented in dash.js, which is a Javascript- based reference implementation of a MPEG-DASH player [4].、

#### QoE metrics

- QoE_lin uses a linear bitrate utility.
- QoE_log uses a logarithmic bitrate utility function，该函数表示其递减的边际效用。
- QoE_hd heavily favors high-definition (HD) video(720p and 1080p) over non-HD.

#### 实验设置

在 Chromium 浏览器（版本 65）上运行 dash.js 实现来流式传输 MPEG-DASH 视频，使用表 1 中列出的 Nvidia 桌面 GPU 生产线的六个 GPU 模型。默认客户端 Nvidia Titan Xp。在该设置中，内容感知 DNN 和 ABR 网络在客户端作为单独的进程运行。为了从网络跟踪仿真网络条件，使用 MaimaHi[55]。

本文使用了两个实验设置。为了在所有六个 GPU 上评估 NAS 客户端，使用了一个本地测试平台。为了规模化训练和测试，使用谷歌云平台。

训练使用配备了 Nvidia 的服务器类 Tesla P100 GPU 的实例完成。然而，Google 云平台没有桌面顶级 GPU，而我们需要将客户端的流媒体实验扩展到 18 小时的网络 trace ×27 视频片段 ×4 种 ABR ×3 种 QoE，总共 5832 小时的流媒体时间。因此，使用每个 GPU 设备上的本地测试对每个视频进行内容感知 DNN 的质量和延迟测量。然后，针对每个网络 trace 对 NAS 服务器和客户端之间的网络状况进行一次仿真，并应用内容感知 DNN 的质量增强和延迟效果。让网络模拟、DNN 模拟的客户端使用少量测试数据生成与本地测试环境的实际客户端相同的 QoE。

### 7.2 NAS 与现有视频传输

#### QoE 提升

图 6 说明，在所有 QoE 指标中，NAS 始终以很大的优势超过 Pensieve：QoE_lin 好 43.08%、QoE_log 好 36.26%、QoE_hd 好 42.57%。使用 QoE_lin 的 NAS 平均性能优于 Pensieve 43.08%，而 Pensieve 比 RobustMPC（R-MPC）提高了 19.31%。与 BOLA 相比，NAS 在 QoE_lin 取得了 92.28% 的进步。与 Pensieve 相比，QoE 的改进幅度从 21.89%(1:“Beauty”) 到 76.04%(6:“音乐”) 不等。

<div align=center><img src="/images/NAS-2022-03-01-22-52-25.png" alt="NAS-2022-03-01-22-52-25" style="zoom:50%;" /></div>

图 7 展示了 QoE 在测试轨迹上的累积分布，“体育”在所有类别中都表现出中等程度的增长。NAS 在所有网络条件下都能带来好处。与 Pensieve 相比，NAS 使 QOE_LIN 的中位数提高了 58.55%。注意，与 Ro-bustMPC 相比，Pensieve 主要通过以比特率效用为代价减少 rebuffering 来实现其 QoE 增益。相比之下，NAS 没有表现出这样的权衡，因为它利用客户端计算。其他内容也显示出类似的趋势。最后，图 8 将 QoE 分解为比特率效用、拒绝惩罚和平滑度惩罚。由于基于 DNN 的质量增强，NAS 从比特率实用程序中获益最大。

<div align=center><img src="/images/NAS-2022-03-01-22-52-53.png" alt="NAS-2022-03-01-22-52-53" style="zoom:50%;" /></div>

<div align=center><img src="/images/NAS-2022-03-03-16-57-26.png" alt="NAS-2022-03-03-16-57-26" style="zoom:50%;" /></div>

#### 带宽节省

尽管存在 DNN 传输开销，但 NAS 在提供相同的 QoE 时需要更少的带宽。

为了证明这点，我们使用块级模拟器 (§5.3) 创建了一个假设设置，其中 NAS 客户端接收的带宽占 Pensieve 客户端接收的带宽的一小部分，包括 DNN 传输开销。调整分数并根据经验确定提供相同 QoE 的分数，假设 NAS 客户端每 5 分钟的视频下载最大的 DNN(“超高”) 模型。图 9 显示了 Pensieve 和 NAS 的平均带宽使用率。平均下来，在所有视频中，NAS 需要的带宽比 Pensieve 少 17.13%，就能提供相同的质量。节省的带宽因内容而异，在 10.69% 到 26.90% 之间。这表明使用 DNN 的好处超过了传输 DNN 的开销。

<div align=center><img src="/images/NAS-2022-03-03-17-10-03.png" alt="NAS-2022-03-03-17-10-03" style="zoom:50%;" /></div>

#### 成本效益分析（服务器端）

对服务器的计算和带宽进行了量化。集成 ABR 的训练时间在 CPU 上只有 10.92 小时。因为它是一次性成本，在所有视频流中摊销，所以额外成本可以忽略不计。相反，内容感知 DNN 必须为每个视频进行训练。每分钟视频的总训练时间（跨越多个 DNN）为 10 分钟。

对于算力，具有 8 个 vCPU、32 GB RAM 和 Nvidia P100 GPU 的 Google 云实例，这相当于每分钟 0.23 美元的视频。对于带宽，亚马逊 CDN 实例最高收费为 0.085 美元/GB。使用的带宽越多，带宽的价格就越便宜。以这些作为参考，我们计算总视频传送成本是每分钟视频累计观看时间的函数。图 10 显示了 NAS 和 Pensieve 的成本比较，我们假设每个用户观看视频片段 5 分钟（即 DNN 每观看五分钟传输一次）。

NAS 会有一些前期计算成本，但随着累计观看时间的增加，它会被摊销。注意，NAS 使用的带宽减少了 17.13%，同时可以提供相同的用户 QoE。因此，当累计观看时间达到 30 小时（系统中每分钟的视频）时，NAS CDN 可以弥补最初的投资。

<div align=center><img src="/images/NAS-2022-03-03-17-14-54.png" alt="NAS-2022-03-03-17-14-54" style="zoom:50%;" /></div>

### 7.3 基于组件的分析

#### Content-awareness

图 11 比较了在标准基准图像（NTIRE 2017 数据集 [19]）上训练的内容感知型 DNN（awDNN）和内容不可知型 DNN（agDNN）的视频质量，以及我们作为输入的原始 240p 视频经 bicubic 插值放大后的质量。我们用 PSNR[35] 和 SSIM[73] 来衡量视频质量。内容感知型 DNN 提供了持续的改进，而内容不可知 DNN 在某些情况下甚至降低了 PNSR 测量（内容类型：6）和 SSIM 测量（类型：1,2,4,5,6）的质量。这证实了我们使用 DNN 的训练能力的理由。

<div align=center><img src="/images/NAS-2022-03-03-17-18-18.png" alt="NAS-2022-03-03-17-18-18" style="zoom:50%;" /></div>

#### Scalable DNN

图 13 显示了使用部分 DNN 的好处。我们比较了 Pensieve、NAS 和全部下载 DNN 的 NAS 版本 (NAS-Full)。图 13(A) 表明了平均完整 DNN 下载时间 (47.82 秒）之前 QoE_lin 的累积分布。只要下载了部分 DNN（平均 22.16 秒），NAS 就会提高质量。结果表明，这在中位数和平均数上分别带来了 17.54%和 3.35%的 QoE 改善。请注意，NAS 和 NAS-Full 的 QoE 在下载完整 DNN 后变得相同 (t>47.82 秒），如图 13(B) 所示。

<div align=center><img src="/images/NAS-2022-03-03-17-20-14.png" alt="NAS-2022-03-03-17-20-14" style="zoom:50%;" /></div>

#### Integrated ABR

集成 ABR 在下载 DNN 期间和之后都能带来好处。为了证明这一点，我们使用块级模拟器创建了两个假设设置（§5.3）。

首先，我们将 NAS 与使用简单 DNN 下载策略的版本进行比较，后者以 Pensieve 选择的视频比特率分段部分下载 DNN，没有集成比特率选择和 DNN 下载决策。我们使用两种变体：一种是以 100% 的视频比特率下载 DNN，另一种是仅使用 10%。两者都配置为在播放缓冲区大于 15.42 秒时开始下载 DNN，这是 NAS 开始在测试流量跟踪中传输 DNN 的平均时间。

我们的结果显示，在对 QoElin 进行 spect 检查时，NAS 的表现分别比 non-aggressive and aggressive strawman 高 16.36% 和 9.13%。图 12 显示了 QoE 组件的比较。与 NAS 相比，non-aggressive 版本的比特率效用更低，因为前者下载 DNN 的速度更慢。相比之下，aggressive 版本会增加 增加了 x2.5 的阻断惩罚，这对 QoE 产生了负面影响。

<div align=center><img src="/images/NAS-2022-03-03-20-39-38.png" alt="NAS-2022-03-03-20-39-38" style="zoom:50%;" /></div>

接下来，为了评估 DNN 完全下载后感知质量增强的比特率选择的收益，我们将 NAS 与 DNN 完全下载后感知质量增强的 ABR 进行比较。图 14（a）显示了该设置下的平均 QoE。感知质量增强的 ABR 为 QoE_hd 带来了巨大的收益（28.96%），而对 QoE_lin 的益处最小（0.01%），对 QoE_log 的影响较小（3.14%）。它为 QoE_hd 带来巨大收益的原因是，1.2Mbps（480p）视频的 DNN 增强质量接近于原始的 2.4Mbps（720p）视频，而 QoE_hd 相对于提高质量的边际效用远远大于任何其他 QoE 类型，尤其是在 1.2Mbps 到 2.4Mbps 之间（表 5）。

<div align=center><img src="/images/NAS-2022-03-03-20-44-55.png" alt="NAS-2022-03-03-20-44-55" style="zoom:50%;" /></div>

如图 14（b）所示，在使用 QoE_hd 时，集成 ABR 更频繁地下载 480p，在比特率决策中带来了这种增强。

### 7.4 对计算的动态适应

#### Heterogeneous clients

视频播放速率为每秒 30 帧。每个客户端在接收到视频清单文件时会执行测试。所选质量水平为“低”、“中”、“高”或“超高”，可以看到，每个设备都会选择一个满足实时约束的设备。

接下来，在云环境中使用四种不同的质量级别来衡量客户的 QoE。图 15 显示了每个质量级别的 QoE_lin 的累积分布。所有质量水平都优于 Pensieve。DNN 的质量级别越高，提供的质量越好。注意，尽管高质量的 DNN 尺寸更大，但与低质量的 DNN 相比，它们带来了更大的增量效益。

<div align=center><img src="/images/NAS-2022-03-03-20-48-57.png" alt="NAS-2022-03-03-20-48-57" style="zoom:50%;" /></div>

总之，研究结果表明，NAS 适用于计算能力迥异设备，计算能力较高的设备会获得更大的效益。

#### 时间变化

我们单独评估客户对算力随时间变化的适应性，通过改变 GPU(Titan XP) 的时钟频率来模拟可用计算能力的变化。我们以 10% 的粒度改变 GPU 时钟频率，并记录所使用的推理路径及其吞吐量。图 16 展示了与仅使用全 DNN(NAS-FULL) 的简单版本相比的结果，并绘制了每个干扰路径在全时钟周期下的归一化吞吐量 (y 轴）的理想线。x 轴表示用于推理的可选块的数量，y 截距表示所需的 DNN 层的计算要求。所有结果的原始吞吐量表明，在底层 DNN 支持的范围内，NAS 可以通过随时预测来适应不断变化的资源，从而提供实时性能。

<div align=center><img src="/images/NAS-2022-03-03-21-11-45.png" alt="NAS-2022-03-03-21-11-45" style="zoom:50%;" /></div>

### 7.5 End-to-end Operation

#### 客户端

<div align=center><img src="/images/NAS-2022-01-12-13-12-33.png" alt="NAS-2022-01-12-13-12-33" style="zoom:50%;" /></div>

1. 下载一个 manifest list，上面是 DNN 的信息；
2. DNN processor 根据 manifest file 的信息开始模拟四种 DNN 的开销，选择能满足实时要求质量最高的一种 DNN 模型，同时 player 已经下载了 1-7 个视频块；
3. 根据 ABR 算法选择开始下载视频块和 DNN 块，这里是下载了第一个 DNN 块，同时 player 已经播放了 1-5 的视频块了；
4. 第一个 DNN 块开始优化 6-7 视频块，并实时播放，同时 player 继续根据 ABR 算法下载视频块和 DNN 块；
5. 在 32 sec 的时候，已经使用了两个 DNN 块进行视频质量提升了；
6. 在 60 sec 的时候，已经使用了完整的 DNN 模型进行优化。

在 t=0.36s 时，下载视频清单并测试运行模拟 DNN 以选择 DNN 质量级别。试运行在 t=2 结束，视频在 t=2.03 开始播放。在 t=17.64s 处，下载第一个 DNN 块，并且在 t=17.71 处初始化最小 DNN。此时，DNN 处理开始，并且重放缓冲器中的视频块 (6-7) 接收质量增强。随后的视频块在到达时由 DNN 处理，当新的 DNN 块到达时，DNN 会逐渐更新。在 t=46.41 时，DNN 完全下载。

#### DNN processing time

评估 NAS 客户端的 DNN 处理延迟。对于 DNN 处理，NAS 流水线一共处理三个进程，每个进程分别进行解码、超分辨率和重新编码。表 7 显示了 4 秒视频块的每个阶段的处理时间。使用 GTX 1080Ti 处理“超高”质量的 DNN，并使用 30fps、240p 视频作为输入，使用 ffmpeg[6] 中的最快选项重新编码 H.264 中的 DNN 输出，因为压缩系数并不重要。序列化每个阶段时的总处理时间为 4.88 秒，而流水线处理时间为 3.76 秒。考虑到超分辨率耗时 3.69s，其余部分的延迟开销最小。

最后，衡量客户端用于 DNN 处理的 GPU 内存使用率。“超高”、“高”、“中”、“低”质量的 DNN 分别使用 3.57 GB、3.12 GB、3.05 GB 和 2.99 GB GPU 内存。

<div align=center><img src="/images/NAS-2022-03-03-21-16-04.png" alt="NAS-2022-03-03-21-16-04" style="zoom:50%;" /></div>

## 八、总结

本文提出了 NAS，一个利用客户端算力来提高视频质量的视频传输系统。与现有的视频传输完全依赖于带宽资源不同，NAS 使用深度神经网络和客户端算力来提升视频质量。NAS 引入了新的系统设计，以解决在 DASH 上实现愿景的实际问题。

对真实网络跟踪上的真实视频的评估显示，NAS 在当前技术状态下，用户体验质量（QoE）提高了 21.89% 到 76.04%。最后，成本效益分析表明，与现有技术相比，CDN 实际上可以降低视频传输的成本，同时提供相同或更好的 QoE。
